#!/usr/bin/env python3
"""
Query classifier for site structure analysis.
Filters, strips, normalizes and categorizes commercial queries (>= 0.35)
into service hub pages, competitor brands, or noise.
"""

import re

# =============================================================================
# FILTER KEYWORDS — queries containing any of these are removed entirely
# =============================================================================
FILTER_KEYWORDS = [
    # --- Distant SPb geo (metro, districts, streets) ---
    'купчино', 'дыбенко', 'ленинск', 'московск район', 'балтийск',
    'большевик', 'девяткино', 'ладожск', 'технологическ', 'озерки',
    'калининск', 'красногвардейск', 'красносельск', 'фрунзенск',
    'адмиралтейск', 'колпин', 'кронштадт', 'петродворц', 'пушкинск',
    'василеостровск', 'чкаловск', 'горьковск', 'электросил',
    'автово', 'проспект ветеранов', 'площадь мужества',
    'гражданск', 'академическ', 'политехническ',
    'удельн', 'чёрная речка', 'черная речка',
    'нарвск', 'обводн',
    'рыбацк', 'петроградск', 'павловск', 'беговая', 'зеленогорск',
    'новочеркасск', 'пролетарск', 'достоевск', 'металлостро',
    'маяковского', 'чайковского', 'московская',
    'ночью', 'круглосуточн', '24 часа',
    # Additional distant streets/areas
    'суворовск', 'васильевск', 'ветеранов',
    'кушелевск', 'южное шоссе', 'русановск', 'международн',
    'елизаровск', 'народн', 'чернышевск', 'славянк',
    'парфеновск', 'невский район', 'кировский район',
    'выборгский район', 'центральн район', 'красное село',
    'савушкин', 'петроградк', 'энергетиков', 'косыгин',
    'бухарестск', 'будапештск', 'среднерогатск', 'пулковск',
    'восстания', 'владимирск', 'бронницк', 'ивановск',
    'новая охта', 'невский проспект', 'героев', 'космонавт',
    'ленинградское шоссе', 'петергофское шоссе', 'выборгское шоссе',
    'орджоникидзе', 'бабушкин', 'октябрьская набережная',
    'муринская дорога', 'дунайск', 'рубинштейн', 'пятилеток',
    'металлистов', 'ульянка', 'осиновая роща', 'лаврики',
    'витебский', 'лыжный', 'федора абрамова',
    'красных зорь', 'стародеревенск', '8 советск', '4 советск',
    'гончарн', 'заставск', 'уточкин', 'кима ',
    'радищев', 'пушкине', 'московском районе',
    '26 линия', 'октябрьск', 'уральск', 'тайнинск',
    'ул фрунзе', 'жк софия',
    # Declension variants of already-filtered places
    'красном селе', 'площади мужества', 'новой охте', 'осиновой роще',
    'центральный район', 'невском районе',
    # More distant metro/areas
    'сенная', 'метро сокол', 'международая',
    'кондратьевск',  # Калининский район — distant
    'звездн', 'звёздн', 'парнас',
    'просвещения', 'лесная', 'на лесной', 'м лесная',
    'приморская', 'на приморской',

    # --- Non-SPb cities ---
    'москв', 'мск', 'краснодар', 'новосибирск', 'екатеринбург',
    'казань', 'нижний новгород', 'самар', 'ростов', 'уфа',
    'воронеж', 'пермь', 'волгоград', 'тюмень', 'красноярск',
    'калуг', 'кирове', 'солнечногорск', 'тихвин', 'мурино',
    'сестрорецк', 'всеволожск', 'пушкин ', 'донецк', 'ялта',
    'пенза', 'чебоксар', 'архангельск', 'кисловодск', 'приозерс', 'сыктывкар',
    'дубай', 'купавн', 'косино', 'ломоносов', 'тосно',
    'печор', 'янино', 'сертолов', 'гатчин', 'строгино',
    'оккервиль', 'чонгарск', 'тульск', 'сходненск', 'сокол ',
    'крылатск', 'молодежн', 'аэропорт', 'вернадского',
    'новослободск', 'шушар', 'в пензе',

    # --- Equipment / repair ---
    'аппарат для', 'фреза', 'фрезы', 'лампа для', 'лампу для',
    'пылесос', 'вытяжк', 'стерилизатор', 'автоклав', 'кусачк',
    'ножниц', 'инструмент', 'набор для', 'marathon', 'runail',
    'strong ', 'drill', 'дрель', 'machine', 'anvikor', 'tersta',
    'sp 100', 'doctor alex', 'ремонт аппарат', 'ремонт машинк',

    # --- Training / DIY ---
    'курс', 'обучени', 'школа маникюр', 'учи', 'научи',
    'для начинающих', 'пошагово', 'самой себе', 'в домашних',
    'дома ', 'домашн', 'своими руками', 'самостоятельно',
    'как делать', 'как сделать', 'как правильно',
    'видео урок', 'видеоурок', 'мастер класс',

    # --- Rental / business ---
    'аренд', 'снять кабинет', 'снять место', 'снять студию',
    'коворкинг', 'рабочее место', 'кв метр', 'санпин',
    'лицензи', 'открыть салон', 'бизнес план', 'франшиз',
    'устроиться', 'найти моделей', 'модели наращивание', 'искать мастер', 'медкнижк',
    'санкнижк', 'медицинская книжк',

    # --- Informational intent ---
    'что это', 'что такое', 'что значит', 'как выглядит',
    'отличие', 'разница', 'чем отличается', 'фото', 'картинк', 'дизайн ногтей',
    'идеи', 'тренд', 'модн', 'новинк',
    'вред', 'опасн', 'можно ли', 'нельзя', 'противопоказан', 'при беременности',
    'сколько держится', 'как часто',
    'плюсы', 'минусы',
    'сколько раз', 'сколько гарантия', 'зачем нужна',
    'длина ногтей', 'для старых', 'с нуля',
    'рейтинг',
    'укреплени',  # SERP is informational (how-to, Pinterest, DIY)
    'коррекция отросш',  # SERP is informational (DIY how-to)
    'топ салон', 'топ студи', 'лучшие студи',
    'пример отзыв',  # informational (how to write a review)

    # --- Design / color queries (informational) ---
    'бирюзов', 'перламутров', 'хаки', 'кошачий глаз',
    'с золот', 'со страз', 'с красными кончик',
    'малинов маникюр', 'матовый малинов',
    'болотного цвета',
    'на длинные', 'на короткие',
    'nail art',

    # --- Specific filters ---
    'на дому',       # no home visits
    'на дом',        # no home visits
    'с выездом',     # no home visits
    'вызвать',       # no home visits
    'вызов мастера', # no home visits

    # --- Health / post-manicure ---
    'грибок', 'болит', 'больн', 'сожгли', 'тонкие ногти',
    'зеленый', 'желтое пятно', 'аптечк',

    # --- Software / misc ---
    'программа для', 'приложение', '2 гис',
    'как пользоваться лампой',

    # --- Booking/promo noise (not commercial service intent) ---
    'бесплатный маникюр', 'абонемент', 'место под маникюр',
    'сайт для записи', 'поиск мастера', 'найти мастер',
    'сеть салонов', 'найти по маникюру',
    'в среднем стоит', 'средний прайс', 'рыночная цена',
    'прайс мастера',
    # Phone numbers / junk
    '7 921', '8 921', '8 812',
    'в торговом центре',
    'специалисты маникюра',
    'невысоким прайсом', 'в среднем',
    'маникюр центр',  # center of city, not our area
]

# Exact-match filter — queries that match exactly (after lowering) are removed
FILTER_EXACT = [
    'маникюр 1', 'маникюр 26', 'маникюр м', 'маникюр д', 'маникюр пр',
]


# =============================================================================
# GEO STRIP — removed from query before normalization (order: longest first)
# =============================================================================
GEO_STRIP = [
    # General geo (longest first)
    'рядом со мной на карте', 'рядом со мной', 'на карте',
    'поблизости со мной', 'поблизости', 'около меня',
    'рядом с домом',
    'санкт петербурге', 'санкт петербург',
    'в спб', 'спб',
    'в петербурге', 'петербург',
    'в питере', 'питер',
    'рядом', 'недалеко',
    # Close-proximity metro/areas (longest first to avoid partial matches)
    'метро комендантский проспект', 'комендантский проспект', 'комендантский',
    'метро пионерская', 'пионерская',
    'метро старая деревня', 'старая деревня',
    'приморский район', 'приморский',
    'жк новоорловский', 'жк шуваловский',  # must come before bare 'шуваловский'
    'шуваловский', 'проспект сизова',
    'на авиаконструкторов', 'авиаконструкторов',
    'на парашютной', 'парашютная', 'парашютной',
    'на плесецкой', 'плесецкая', 'плесецкой',
    'на ильюшина', 'ильюшина',
    'юнтолово',
    'чистое небо',  # ЖК Чистое небо (close proximity)
    # Orphan geo terms (leftover after specific metro stripping)
    'метро', 'жк',
]


# =============================================================================
# TRANSACTIONAL STRIP — removed before normalization
# =============================================================================
TRANSACTIONAL_STRIP = [
    # Price/cost (longest first)
    'сколько стоит', 'стоимость', 'средняя стоимость',
    'недорого', 'цена', 'цены',
    # Booking
    'свободная запись на', 'запись на', 'записаться на', 'записаться',
    'свободные окошки на', 'свободные места на',
    # Place/provider
    'салоны', 'салон красоты', 'салон', 'студия', 'студии',
    'кабинет', 'мастера', 'мастер',
    'сделать', 'услуги', 'мастеру',
    # Quality
    'хорошие', 'лучшие', 'хороший', 'лучший',
    'качественно', 'дешевый', 'дешево', 'премиум',
    # Misc transactional
    'адреса', 'телефон', 'акция', 'ближайший',
    'где можно', 'где',
    'топ ',
    # Content signals (strip for hub matching, but queries stay — signals page content needs)
    'отзывы', 'отзыв',
    'от клиента своими словами', 'от клиентов', 'от клиента',
    'своими словами', 'написать',
    'прайс', 'абонемент', 'рыночная цена',
]


# =============================================================================
# SERVICE HUBS — 2-word hub pages with their matching keywords
# =============================================================================
SERVICE_HUBS = {
    'мужской маникюр': ['мужск'],
    'японский маникюр': ['японск'],
    'пилочный маникюр': ['пилочн'],
    'медицинский маникюр': ['медицинск', 'лечебн', 'подолог'],
    'маникюр и педикюр в 4 руки': [
        '4 руки', '4руки', 'четыре руки', '6 рук',
    ],
    'аппаратный маникюр': ['аппаратн'],
    'комбинированный маникюр': ['комбинирован'],
    'детский маникюр': ['детск', 'подростк', 'для детей'],
    'гигиенический маникюр': ['гигиеническ'],
    'классический маникюр': ['классическ', 'обрезн', 'необрезн'],
    'европейский маникюр': ['европейск'],
    'маникюр с покрытием': ['с покрытием', 'с покрытие', 'гелевым покрытием', 'лаком'],
    'маникюр luxio': ['luxio'],
    'маникюр без покрытия': ['без покрытия', 'без покрытие', 'без покраски'],
    'наращивание ногтей': ['наращива', '-без наращивания', '-без наращивани'],
    'маникюр втирка': ['втирк'],
    'пудровый маникюр': ['пудров', 'порошков', 'дип маникюр', 'дип систем', 'дип-систем'],
    'маникюр омбре': ['амбре', 'омбре', 'градиент'],
    'френч маникюр': ['френч', 'французск'],
    'креативный маникюр': ['креативн', 'арт маникюр'],
    'спа маникюр': ['спа маникюр', 'spa маникюр'],
    'экспресс маникюр': ['экспресс'],
    'корейский маникюр': ['корейск'],
    'снятие маникюра': ['снятие'],
    'акции и скидки на маникюр': ['скидк', 'акци', 'первое посещение', 'первый визит'],
    # 'укрепление ногтей' removed — SERP is 100% informational
    'маникюр с дизайном': ['дизайн'],
    'немецкий маникюр': ['немецк', 'lcn'],
    'пленочный маникюр': ['пленочн'],
}


# =============================================================================
# COMPETITOR BRANDS — known salon/brand names in queries
# =============================================================================
COMPETITORS = [
    # Major brands
    'зефирка', 'сиерра', 'sierra', 'гуру маникюра', 'guru', 'теплота',
    'ai маникюр', 'gastronom', 'милано', 'аврора', 'леона', 'leona',
    'клюква', 'другой маникюр', 'дриада', 'полюбви', 'lseven', 'l seven',
    'пош ', 'posh', 'артистри', 'карамель', 'девчата',
    'лена ленин', 'лены ленин', 'комната', 'ликс', 'сода маникюр', 'игуана',
    'элевен', 'джангл', 'lollipop', 'малинина', 'дикиди', 'dikidi', 'didiki',
    'мекка', 'когтеточка', 'матрешка', 'серебро маникюр', 'канди',
    'маникюр май', '31 маникюр', 'эстетик маникюр', 'хочу маникюр',
    'рокко барокко', 'точка красоты', 'smart nail',
    'ноготки салон', 'ноготки маникюр', 'ноготочки', 'set beauty', 'сет бьюти',
    'бьюти маникюр', 'nail маникюр',
    # SERP-confirmed competitor brands
    'nogtinogti', 'ногти салон маникюра', 'ногти маникюр',
    'цвет салон', 'миндаль', 'малина', 'мила ',
    'хорьки', 'тут красиво', 'ma bell', 'царапки', 'black cats',
    'минаева', 'кат маркет', '312 ', 'honey money', 'cherie',
    'город 812', 'тонкие линии', 'super art', 'супер арт', 'ногтевая хижина',
    'про маникюр', 'грин парк', 'простые радости', 'красивые люди',
    'бора бора', 'голые ногти', 'сахар маникюр', 'атмосфера красоты',
    'по любви маникюр', 'солнечный город', 'цветной город',
    'гранд каньон', 'новоколомяжский',
    'beauty nails', 'мурину бьюти', 'торговом центре июнь',
    'ноготки на энгельса', 'городская роща',
    'континент',  # ТЦ Континент (Звездная)
    'маникюра мила',  # specific salon (backup for 'мила ' edge cases)
    'мастерс ',  # Masters salon chain
    'март',  # Mart Studio Marianna Aleksandrova
    # 4hands salon chain (SERP-confirmed competitor, not "4 руки" service)
    '4 хэндс', '4 хенд', '4 hands', '4 hans', '4hands',
    'dashasavii',  # specific master handle (пилочный маникюр)
]


# =============================================================================
# FUNCTIONS
# =============================================================================

def is_filtered(query: str) -> bool:
    """Return True if query should be excluded from analysis."""
    ql = query.lower().strip()
    if ql in FILTER_EXACT:
        return True
    for kw in FILTER_KEYWORDS:
        if kw in ql:
            return True
    return False


def strip_query(query: str) -> str:
    """Strip geo and transactional modifiers to get the core phrase."""
    q = query.lower().strip()
    # Sort by length descending to match longest phrases first
    for geo in sorted(GEO_STRIP, key=len, reverse=True):
        q = q.replace(geo, ' ')
    for t in sorted(TRANSACTIONAL_STRIP, key=len, reverse=True):
        q = q.replace(t, ' ')
    # Remove orphan numbers first (leftover from address stripping, e.g. "61 1", "2/6")
    q = re.sub(r'\s+', ' ', q).strip()
    q = re.sub(r'\b\d+[/к]?\d*\b', '', q)
    # Clean up leftover single letters (NOT 'с' — it's part of hub keywords)
    q = re.sub(r'\s+', ' ', q).strip()
    q = re.sub(r'\b[вмндеоу]\b', '', q)
    # Remove orphan 'на', 'пр', 'все', 'со' at start/end
    q = re.sub(r'\s+', ' ', q).strip()
    q = re.sub(r'^(на|пр|все|со)\s+', '', q)
    q = re.sub(r'\s+(на|пр|все|со)$', '', q)
    q = re.sub(r'\s+', ' ', q).strip()
    return q if q else 'маникюр'


def categorize(query: str, original_query: str = None) -> str:
    """Categorize a query into a hub page, 'COMPETITOR', or 'маникюр (главная)'.

    Args:
        query: stripped/normalized query (used for hub matching)
        original_query: original query before stripping (used for competitor matching)
    """
    # Check competitors against original query (before stripping) AND stripped query
    orig = (original_query or query).lower()
    ql = query.lower()
    for comp in COMPETITORS:
        if comp in orig or comp in ql:
            return 'COMPETITOR'
    # Check hubs against both stripped and original query
    for hub, keywords in SERVICE_HUBS.items():
        excludes = [kw[1:] for kw in keywords if kw.startswith('-')]
        includes = [kw for kw in keywords if not kw.startswith('-')]
        # Skip hub if any exclude pattern matches
        if any(ex in orig or ex in ql for ex in excludes):
            continue
        for kw in includes:
            if kw in ql or kw in orig:
                return hub
    return 'маникюр (главная)'


def load_commercial_queries(xlsx_path: str, min_commercialization: float = 0.35):
    """Load queries with commercialization >= threshold from deep_parse_results."""
    import openpyxl
    wb = openpyxl.load_workbook(xlsx_path, read_only=True)
    ws = wb.active
    headers = [cell.value for cell in ws[1]]

    sq_col = headers.index('Search Query')
    vol_col = headers.index('Search Volume (Exact Match Type)')
    cl_col = headers.index('Commercialization Level')

    rows = []
    for row in ws.iter_rows(min_row=2, values_only=True):
        val = row[cl_col]
        if val is not None and float(val) >= min_commercialization:
            vol = row[vol_col] if row[vol_col] else 0
            rows.append((str(row[sq_col]).strip(), vol, float(val)))
    wb.close()
    return rows


def get_clean_queries(xlsx_path: str):
    """Load, filter, and return clean commercial queries."""
    rows = load_commercial_queries(xlsx_path)
    return [(q, v, c) for q, v, c in rows if not is_filtered(q)]
