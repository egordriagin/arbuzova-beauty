# Заявка на доступ к API Яндекс.Директа — техническое описание

## 1. Подробное техническое описание работы приложения

### Цель приложения

Приложение предназначено для SEO-анализа — получения прогноза показов по ключевым фразам в тематике бьюти-услуг (маникюр, педикюр, дизайн ногтей) в регионе Санкт-Петербург. Данные необходимы для планирования структуры сайта салона красоты — распределения ключевых фраз по страницам на основе реального поискового спроса.

### Используемые методы API

Приложение использует **API v4 (Live)**, а именно методы сервиса прогнозирования:

| Метод | Назначение |
|-------|-----------|
| **CreateNewForecast** | Создание прогноза показов, кликов и затрат для батча ключевых фраз (до 100 фраз) с указанием региона (GeoID = [2], Санкт-Петербург) и валюты (RUB) |
| **GetForecastList** | Проверка статуса готовности отчёта (Done / Pending / Failed) |
| **GetForecast** | Получение результатов: Shows (прогноз показов за месяц), Clicks, CTR, CPC по каждой фразе |
| **DeleteForecastReport** | Удаление отчёта после получения данных для освобождения слота (максимум 5 одновременных отчётов) |

Никакие другие сервисы API Директа (Campaigns, Ads, AdGroups, Bids и т.д.) приложением **не используются**. Приложение не создаёт, не редактирует и не управляет рекламными кампаниями.

### Схема последовательности вызовов

```
1. Загрузка списка ключевых фраз из локального файла (XLSX, ~33 000 фраз)
2. Разбивка на батчи по 100 фраз (лимит CreateNewForecast)
3. Для каждого батча:

   a. POST → CreateNewForecast
      {
        "method": "CreateNewForecast",
        "token": "...",
        "locale": "ru",
        "param": {
          "Phrases": ["фраза1", ..., "фраза100"],
          "GeoID": [2],
          "Currency": "RUB"
        }
      }
      → Получаем ForecastID

   b. Цикл опроса каждые 15 секунд:
      POST → GetForecastList
      → Проверяем StatusForecast для нашего ForecastID
      → Ждём статус "Done" (обычно ~1 минута)

   c. POST → GetForecast (param = ForecastID)
      → Получаем массив Phrases с Shows, Clicks, CTR, CPC

   d. POST → DeleteForecastReport (param = ForecastID)
      → Освобождаем слот

   e. Сохранение результатов в локальный XLSX-файл

4. Итоговый файл со всеми прогнозами
```

### Частота вызовов и потоки

- **Количество потоков:** 1 (одно последовательное соединение)
- **Одновременные соединения:** 1 (лимит API: 5)
- **Цикл одного батча:** ~4 запроса за ~1 минуту:
  - 1× CreateNewForecast
  - 2–4× GetForecastList (опрос каждые 15 сек)
  - 1× GetForecast
  - 1× DeleteForecastReport
- **Общее количество батчей:** ~329 (32 814 фраз ÷ 100)
- **Общее количество запросов:** ~1 300–2 000
- **Общее время работы:** ~5–6 часов
- **Характер использования:** разовый сбор данных, повторение раз в 1–3 месяца

## 2. Для каких целей используются методы API

| Метод | Цель |
|-------|------|
| CreateNewForecast | Запуск формирования прогноза показов для батча ключевых фраз в регионе Санкт-Петербург. Получение ForecastID для последующего скачивания результатов. |
| GetForecastList | Проверка статуса готовности отчёта перед его скачиванием. Позволяет не делать лишних запросов к GetForecast до завершения формирования. |
| GetForecast | Получение прогнозных данных: Shows (показы за месяц), Clicks, CTR, CPC — для оценки поискового спроса и приоритизации ключевых фраз при построении структуры сайта. |
| DeleteForecastReport | Удаление обработанного отчёта для освобождения слота (лимит 5 одновременных отчётов). |

Приложение **не используется** для:
- Управления рекламными кампаниями
- Автоматического назначения ставок
- Создания или модерации объявлений
- Работы с несколькими клиентскими аккаунтами

## 3. Объём данных

### Текущий объём
- **Клиенты:** 1 (собственный аккаунт)
- **Кампании:** 0 (приложение не работает с кампаниями)
- **Объявления:** 0
- **Ключевые фразы для анализа:** 32 814

### Планируемый объём
- **Клиенты:** 1
- **Кампании:** 0
- **Ключевые фразы:** до 50 000 (возможно расширение семантического ядра)
- **Частота обновления:** раз в 1–3 месяца (для отслеживания сезонных изменений спроса)

## 4. Учёт технических и балльных ограничений

1. **Лимит одновременных отчётов (5 штук):**
   - Каждый отчёт удаляется сразу после получения данных (DeleteForecastReport)
   - При ошибке 31 (лимит) — автоматическая очистка всех отчётов и повтор
   - В любой момент на сервере не более 1 активного отчёта

2. **Лимит фраз в запросе (100):**
   - Размер батча строго 100 фраз (или меньше для последнего батча)

3. **Контроль баллов (Units):**
   - При ошибке 152 (нехватка баллов) — пауза 60 секунд и повтор
   - Ведётся локальный лог расхода баллов

4. **Ограничение соединений:**
   - Используется строго 1 поток (далеко в пределах лимита 5 соединений)
   - Между батчами — естественная пауза (~1 мин на формирование отчёта)

5. **Суточный лимит баллов:**
   - При нехватке баллов работа приостанавливается до восстановления

## 5. Обработка ошибок

| Код ошибки | Тип | Действие |
|-----------|------|---------|
| 31 | Лимит отчётов (5 макс.) | Удаление всех отчётов через DeleteForecastReport, повтор запроса |
| 52 (NOT_ENOUGH_UNITS) | Нехватка баллов | Пауза 60 секунд, повтор запроса |
| 53 (CONCURRENT_LIMIT) | Превышен лимит соединений | Пауза 5 секунд, повтор запроса |
| 500, 502, 503 | Внутренние ошибки сервера | Экспоненциальный backoff: 2с → 4с → 8с, до 3 попыток |
| 1000, 1001, 1002 | Ошибки авторизации | Логирование, остановка приложения |
| StatusForecast = "Failed" | Ошибка формирования отчёта | Удаление отчёта, пропуск батча, добавление в очередь повторной обработки |
| Таймаут ожидания | Отчёт не готов за 10 минут | Удаление отчёта, пропуск батча |
| Прочие ошибки | — | Логирование, пропуск батча, продолжение работы |

**Общая стратегия:**
- Все ошибки логируются с телом запроса и ответа
- При 3 неудачных попытках подряд — батч пропускается и добавляется в очередь на повторную обработку
- Прогресс сохраняется после каждого успешного батча (поддержка возобновления при сбое)
- При критических ошибках (авторизация, блокировка) — приложение останавливается
